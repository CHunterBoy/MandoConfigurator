<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mando Configurator</title>
</head>
<body>
    <h1>Mando Configurator</h1>

    <div><div class="spb-label-tooltip"><label for="Helmet_Type-0-40" class="spb-productdescfont spb-productdesctextcolor">Helmet Type</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Helmet_Type-0-40" name="properties[Helmet_Type]"><option selected value="Classic">Classic</option><option value="Hero">Hero</option><option value="Female">Female</option><option value="Rebel">Rebel</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Dome_Color-0-41" class="spb-productdescfont spb-productdesctextcolor">Dome Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Dome_Color-0-41" name="properties[Dome_Color]"><option selected value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Faceplate_Color-0-42" class="spb-productdescfont spb-productdesctextcolor">Faceplate Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Faceplate_Color-0-42" name="properties[Faceplate_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Cheek_Indent_Color-0-43" class="spb-productdescfont spb-productdesctextcolor">Cheek Indent Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Cheek_Indent_Color-0-43" name="properties[Cheek_Indent_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Cheek_Arch_Color-0-44" class="spb-productdescfont spb-productdesctextcolor">Cheek Arch Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Cheek_Arch_Color-0-44" name="properties[Cheek_Arch_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Fin_Color-0-50" class="spb-productdescfont spb-productdesctextcolor">Fin Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Fin_Color-0-50" name="properties[Fin_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>

    <!-- <div><div class="spb-label-tooltip"><label for="Ear_Cap_Color-0-45" class="spb-productdescfont spb-productdesctextcolor">Ear Cap Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Ear_Cap_Color-0-45" name="properties[Ear_Cap_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_ Blue">Sand_ Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Ear_Bar_Color-0-46" class="spb-productdescfont spb-productdesctextcolor">Ear Bar Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Ear_Bar_Color-0-46" name="properties[Ear_Bar_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Back_Ridge_Color-0-47" class="spb-productdescfont spb-productdesctextcolor">Back Ridge Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Back_Ridge_Color-0-47" name="properties[Back_Ridge_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Back_Plate_Color-0-48" class="spb-productdescfont spb-productdesctextcolor">Back Plate Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Back_Plate_Color-0-48" name="properties[Back_Plate_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    <div><div class="spb-label-tooltip"><label for="Vent_Color-0-49" class="spb-productdescfont spb-productdesctextcolor">Vent Color</label></div><span><div class="spb-select"><select class="spb-productdescfont spb-productoptiontextcolor spb-productoptionbackground" id="Vent_Color-0-49" name="properties[Vent_Color]"><option value="White">White</option><option value="Black">Black</option><option value="Pearl_Dark_Gray">Pearl_Dark_Gray</option><option value="Dark_Bluish_Gray">Dark_Bluish_Gray</option><option value="Light_Bluish_Gray">Light_Bluish_Gray</option><option value="Sand_Blue">Sand_Blue</option><option value="Dark_Brown">Dark_Brown</option><option value="Red">Red</option><option value="Dark_Red">Dark_Red</option><option value="Dark_Orange">Dark_Orange</option><option value="Orange">Orange</option><option value="Dark_Tan">Dark_Tan</option><option value="Yellow">Yellow</option><option value="Olive_Green">Olive_Green</option><option value="Apple_Green">Apple_Green</option><option value="Green">Green</option><option value="Dark_Green">Dark_Green</option><option value="Dark_Blue">Dark_Blue</option><option value="Blue">Blue</option><option value="Dark_Azure">Dark_Azure</option><option value="Purple">Purple</option><option value="Lavender">Lavender</option><option value="Pink">Pink</option><option value="Dark_Pink">Dark_Pink</option><option value="Transparent">Transparent</option><option value="Medium_Blue">Medium_Blue</option></select></div></span></div>
    -->
    
    <!-- Canvas to display the blended image -->
    <canvas id="canvas"></canvas>

    <!-- Canvas to process an image -->
    <canvas id="processCanvas" style="display:none"></canvas>

    <button id="createMando" onclick="create()" >Create Mando Fig</button>

    <script>
          // Event listener for when both images are loaded and ready
        const canvas = document.getElementById('canvas');        
        const ctx = canvas.getContext('2d');
        const processCanvas = document.getElementById('processCanvas');        
        const processctx = processCanvas.getContext('2d');
        const downloadButton = document.getElementById('downloadButton');

          // https://rebrickable.com/colors/ 
        const colorOptions = [{ name: "White", hex: "F2F3F2" }, { name: "Black", hex: "05131D" }, { name: "Pearl_Dark_Gray", hex: "575857" }, { name: "Dark_Bluish_Gray", hex: "6C6E68" }, { name: "Light_Bluish_Gray", hex: "A0A5A9" }, { name: "Sand_Blue", hex: "6074A1" }, { name: "Dark_Brown", hex: "352100" }, { name: "Red", hex: "C91A09" }, { name: "Dark_Red", hex: "720E0F" }, { name: "Dark_Orange", hex: "A95500" }, { name: "Orange", hex: "FE8A18" }, { name: "Dark_Tan", hex: "958A73" }, { name: "Yellow", hex: "F2CD37" }, { name: "Olive_Green", hex: "9B9A5A" }, { name: "Apple_Green", hex: "76CD26" }, { name: "Green", hex: "237841" }, { name: "Dark_Green", hex: "184632" }, { name: "Dark_Blue", hex: "0A3463" }, { name: "Blue", hex: "0055BF" }, { name: "Dark_Azure", hex: "078BC9" }, { name: "Purple", hex: "81007B" }, { name: "Lavender", hex: "E1D5ED" }, { name: "Pink", hex: "FC97AC" }, { name: "Dark_Pink", hex: "C870A0" }, { name: "Transparent", hex: "FCFCFC" }, { name: "Medium_Blue", hex: "5A93DB" }];
        const figureOptions = [{filename: "cheekarch.jpg", id:"image4", selectBox : "Cheek_Arch_Color-0-44"},
                                {filename: "cheekindent.jpg", id:"image3", selectBox : "Cheek_Indent_Color-0-43" },
                                {filename: "faceplate.jpg", id: "image2" , selectBox : "Faceplate_Color-0-42"},
                                {filename: "dome.jpg", id: "image1", selectBox : "Dome_Color-0-41"},
                                {filename: "fin.jpg", id: "image5", selectBox : "Fin_Color-0-50"}];

        // Create an index on name
        const colorNameIndex = colorOptions.reduce((index, color) => {
            index[color.name] = color;
            return index;
        }, {});
    
        // Create an object indexed by `selectBox`
        const figureDetailsIndex = figureOptions.reduce((acc, file) => {
                acc[file.id] = file;
                return acc;
        }, {});

        // Create image elements for both local files
        //TODO = dont love this - need to try and get this working in memory without needing all these unique images.
        let image1 = new Image();
        let image2 = new Image();
        let image3 = new Image();
        let image4 = new Image();
        let image5 = new Image();

        // Set the source paths for the local images   
        image1.src = figureDetailsIndex['image1'].filename
        image2.src = figureDetailsIndex['image2'].filename
        image3.src = figureDetailsIndex['image3'].filename
        image4.src = figureDetailsIndex['image4'].filename
        image5.src = figureDetailsIndex['image5'].filename
      
      
                                
        //, id="Ear_Cap_Color-0-45"
        //, id="Ear_Bar_Color-0-46"
        //, id="Back_Ridge_Color-0-47"
        //, id="Back_Plate_Color-0-48"
        //, id="Vent_Color-0-49"

     

       
        function getRGBByImageName(name)
        {
            var deets = figureDetailsIndex[name];
            var selectBox = document.getElementById(deets.selectBox);       
            var rgb = colorNameIndex[selectBox.value];
            return rgb.hex;
        }
       
        function changePixels(imageObject, imageName) {
                           
                var rgb = getRGBByImageName(imageName);
                var color = hexToRgb(rgb);

                processCanvas.width = Math.max(imageObject.width);
                processCanvas.height = Math.max(imageObject.height);

                // Draw the image onto the canvas
                processctx.drawImage(imageObject, 0, 0);

                // Get image data from the canvas
                const imageData = processctx.getImageData(0, 0, processCanvas.width, processCanvas.height);
                const data = imageData.data;

                // Loop through all the pixels and modify the green, blue, and red ones
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];       // Red channel
                    const g = data[i + 1];   // Green channel
                    const b = data[i + 2];   // Blue channel
                    const a = data[i + 3];   // Alpha channel (opacity)

                    // Check if the red, green, and blue values fall within the specified ranges
                    if (r >= 0 && r <= 200 && g >= 186 && g <= 255 && b >= 180 && b <= 255) {
                        // Change the pixel color to whatever we've selected
                        data[i] =  color.r; 
                        data[i + 1] = color.g; 
                        data[i + 2] = color.b; 
                    }
                }

                // Put the modified image data back onto the canvas
                processctx.putImageData(imageData, 0, 0);
                   
                return processCanvas;
            }
      
            function hexToRgb(hex) {
                // Remove the # if present
                hex = hex.replace("#", "");

                // Check if it's a 3-digit hex code and expand if so
                if (hex.length === 3) {
                    hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
                }

                // Parse the hex values into decimal
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);

                return { r, g, b };
                }

        // Function to blend the images using the 'darken' blending mode
        function create() {
           

            if (image1.complete && image2.complete  && image3.complete  && image4.complete  && image5.complete) {
                // Set the canvas size to match the largest image dimensions
                canvas.width = Math.max(image1.width, image2.width);
                canvas.height = Math.max(image1.height, image2.height);
          

                ctx.drawImage(changePixels(image1, 'image1'), 0, 0);
                // Draw the first image onto the canvas
                //ctx.drawImage(changed, 0, 0);

                // Set the blending mode to 'darken'
                ctx.globalCompositeOperation = 'darken';

                // Draw the second image onto the canvas
                ctx.drawImage(changePixels(image2, 'image2'), 0, 0);
                ctx.drawImage(changePixels(image3, 'image3'), 0, 0);
                ctx.drawImage(changePixels(image4, 'image4'), 0, 0);
                ctx.drawImage(changePixels(image5, 'image5'), 0, 0);
              
            }
        }

    </script>
</body>
</html>
